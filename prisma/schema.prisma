generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Conversacion {
  id        Int       @id @default(autoincrement())
  nombre    String
  categoria String
  active    Boolean?  @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  empresaId String
  clientes  Cliente[]
  Empresas  Empresas  @relation("ConversacionesToEmpresas", fields: [empresaId], references: [id])
  mensajes  Mensaje[]

  @@map("Conversaciones")
}

model Mensaje {
  id                    Int          @id @default(autoincrement())
  conversacionId        Int
  anyWord               Boolean      @default(false)
  palabrasClave         String
  cuerpo                String?      @db.VarChar(1000)
  mediaType             MediaType?
  link                  String?
  predecesorId          Int?
  altMessage            String?      @db.VarChar(1000)
  mensajeAsesor         Boolean?     @default(false)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  backToLastMessageCode String?      @db.VarChar(20)
  backToMainCode        String?      @db.VarChar(20)
  repeatMessageCode     String?      @db.VarChar(20)
  cliente               Cliente[]
  conversaciones        Conversacion @relation(fields: [conversacionId], references: [id])
  predecesor            Mensaje?     @relation("MessageSubMessage", fields: [predecesorId], references: [id])
  successor             Mensaje[]    @relation("MessageSubMessage")

  @@map("Mensajes")
}

model Usuario {
  id            Int           @id @default(autoincrement())
  nombre        String        @db.VarChar(100)
  apellido      String        @db.VarChar(100)
  whatsapp      String        @unique
  email         String        @unique
  password      String
  avatar        String?       @db.VarChar(100)
  roleId        Int?
  roleDefaultId String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  empresaId     String
  status        Boolean?      @default(true)
  ChatHistory   ChatHistory[]
  Empresas      Empresas      @relation("EmpresasToUsuarios", fields: [empresaId], references: [id])
  RolesDefault  RolesDefault? @relation("RolesDefaultToUsuarios", fields: [roleDefaultId], references: [id])
  Roles         Roles?        @relation("RolesToUsuarios", fields: [roleId], references: [id])

  @@map("Usuarios")
}

model App {
  id                Int      @id @default(autoincrement())
  nombre            String   @db.VarChar(50)
  appId             String?  @unique
  token             String?  @unique
  businessAccountId String?  @unique
  phoneNumberId     String?  @unique
  webHookApi        String?  @unique
  webHookToken      String?  @unique
  secretKey         String?  @unique
  empresaId         String   @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Empresas          Empresas @relation("AppsToEmpresas", fields: [empresaId], references: [id])

  @@map("Apps")
}

model Cliente {
  id              Int           @id @default(autoincrement())
  nombre          String        @db.VarChar(100)
  apellido        String        @db.VarChar(100)
  nombreEmpresa   String?       @db.VarChar(100)
  whatsapp        String
  codigo          Int
  email           String?       @db.VarChar(100)
  categoria1      String?
  categoria2      String?
  num1            Int?
  num2            Int?
  text1           String?
  text2           String?
  date1           DateTime?
  date2           DateTime?
  conversacionId  Int?
  ultimoMensajeId Int?
  isChating       Boolean?      @default(false)
  chatAsesorId    Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  empresaId       String
  ChatHistory     ChatHistory[]
  botId           Conversacion? @relation(fields: [conversacionId], references: [id])
  Empresas        Empresas      @relation("ClientesToEmpresas", fields: [empresaId], references: [id])
  ultimoMensaje   Mensaje?      @relation(fields: [ultimoMensajeId], references: [id])

  @@map("Clientes")
}

model MensajeLog {
  id         Int      @id @default(autoincrement())
  mensajeId  String   @unique
  status     String
  recipentId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("MensajeLogs")
}

model RegistroCarga {
  id             Int              @id @default(autoincrement())
  descripcion    String?
  archivoOrigen  String
  totalRegistros Int
  registrosOk    Int
  registrosError Int
  status         String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  empresaId      String
  DetallesCargas DetallesCargas[] @relation("DetallesCargasToRegistrosCargas")
  Empresas       Empresas         @relation("EmpresasToRegistrosCargas", fields: [empresaId], references: [id])

  @@map("RegistrosCargas")
}

model RegistroMensaje {
  id              Int               @id @default(autoincrement())
  descripcion     String
  templateUsed    String
  status          Status            @default(ENVIADO)
  scheduledDate   String?
  templateId      String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  empresaId       String
  CampaignDetails CampaignDetails[] @relation("CampaignDetailsToRegistrosMensajes")
  Empresas        Empresas          @relation("EmpresasToRegistrosMensajes", fields: [empresaId], references: [id])

  @@map("RegistrosMensajes")
}

model DetallesCargas {
  id              Int           @id @default(autoincrement())
  registroCargaId Int
  nombresCliente  String
  whatsappCliente String
  emailCliente    String?
  causeError      String?
  status          String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  RegistrosCargas RegistroCarga @relation("DetallesCargasToRegistrosCargas", fields: [registroCargaId], references: [id])
}

model CampaignDetails {
  id                Int             @id @default(autoincrement())
  clienteId         Int?
  nombre            String
  apellido          String
  whatsapp          String
  email             String?
  registroMensajeId Int
  enviado           Boolean?        @default(false)
  entregado         Boolean?        @default(false)
  leido             Boolean?        @default(false)
  whatsappMessageId String?         @unique
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  RegistroMensaje   RegistroMensaje @relation("CampaignDetailsToRegistrosMensajes", fields: [registroMensajeId], references: [id])
}

model Acciones {
  id           Int            @id @default(autoincrement())
  nombre       Actions        @unique
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  Roles        Roles[]        @relation("AccionToRol")
  RolesDefault RolesDefault[] @relation("AccionToRolDefault")
}

model Empresas {
  id              String            @id
  ruc             String            @unique @db.VarChar(50)
  whatsapp        String            @unique @db.VarChar(15)
  nombre          String            @db.VarChar(100)
  logo            String?           @db.VarChar(100)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  App             App?              @relation("AppsToEmpresas")
  ChatHistory     ChatHistory[]
  Cliente         Cliente[]         @relation("ClientesToEmpresas")
  Conversacion    Conversacion[]    @relation("ConversacionesToEmpresas")
  RegistroCarga   RegistroCarga[]   @relation("EmpresasToRegistrosCargas")
  RegistroMensaje RegistroMensaje[] @relation("EmpresasToRegistrosMensajes")
  Roles           Roles[]
  Usuario         Usuario[]         @relation("EmpresasToUsuarios")
}

model Roles {
  id        Int        @id @default(autoincrement())
  nombre    String     @db.VarChar(50)
  empresaId String
  createdAt DateTime   @default(now())
  updatedAt DateTime
  Empresas  Empresas   @relation(fields: [empresaId], references: [id])
  Usuario   Usuario[]  @relation("RolesToUsuarios")
  Acciones  Acciones[] @relation("AccionToRol")
}

model RolesDefault {
  id        String       @id
  nombre    DefaultRoles @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime
  Usuario   Usuario[]    @relation("RolesDefaultToUsuarios")
  Acciones  Acciones[]   @relation("AccionToRolDefault")
}

model ChatHistory {
  id        Int        @id @default(autoincrement())
  clienteId Int
  asesorId  Int?
  mensaje   String?
  media     String?
  mediaType MediaType?
  isClient  Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime
  empresaId String
  Usuario   Usuario?   @relation(fields: [asesorId], references: [id])
  Cliente   Cliente    @relation(fields: [clienteId], references: [id])
  Empresas  Empresas   @relation(fields: [empresaId], references: [id])
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum Status {
  ENVIADO
  ERROR
  EN_COLA
}

enum Actions {
  CREAR_APP
  EDITAR_APP
  ELIMINAR_APP
  VER_APP
  CREAR_PLANTILLA
  EDITAR_PLANTILLA
  ELIMINAR_PLANTILLA
  VER_PLANTILLA
  CREAR_BOT
  EDITAR_BOT
  ELIMINAR_BOT
  VER_BOT
  CREAR_EMPRESA
  EDITAR_EMPRESA
  ELIMINAR_EMPRESA
  VER_EMPRESA
  CREAR_USUARIO
  EDITAR_USUARIO
  ELIMINAR_USUARIO
  VER_USUARIO
  CREAR_CLIENTE
  EDITAR_CLIENTE
  ELIMINAR_CLIENTE
  VER_CLIENTE
  CREAR_ROL
  EDITAR_ROL
  ELIMINAR_ROL
  VER_ROL
  CREAR_CAMPAIGNS
  VER_LOGS
}

enum DefaultRoles {
  ADMIN
  OPERADOR
  CREADOR_PLANTILLAS
}
